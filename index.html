<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Base64 TLV → JSON ASCII</title>
  <style>
    body { font-family: monospace; max-width: 800px; margin: 20px auto; padding: 20px; }
    textarea { width: 100%; height: 100px; font-family: monospace; margin-bottom: 10px; }
    button { padding: 10px 16px; font-size: 16px; }
    pre { background: #f4f4f4; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Base64 → TLV → JSON ASCII</h2>
  <textarea id="base64Input" placeholder="Paste Base64 here..."></textarea>
  <button onclick="decodeTLV()">Decode</button>
  <pre id="output"></pre>

  <script>
    function decodeTLV() {
      const base64 = document.getElementById("base64Input").value.trim();
      try {
        const hex = atob(base64).split('').map(c =>
          ('0' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join('').toUpperCase();
        const parsed = parseTLV(hex);
        document.getElementById("output").textContent = format(parsed);
      } catch (e) {
        document.getElementById("output").textContent = "❌ Invalid Base64 input";
      }
    }

    function parseTLV(hex) {
      let i = 0;
      const result = {};

      const keepAsHexTags = ['4F', '9F25', '63'];
      const asciiTags = ['50', '5F20', '5F2D', '5F50', '85'];

      while (i < hex.length) {
        // Tag
        let tag = hex.substr(i, 2);
        i += 2;
        if ((parseInt(tag, 16) & 0x1F) === 0x1F) {
          while ((parseInt(hex.substr(i, 2), 16) & 0x80) === 0x80) {
            tag += hex.substr(i, 2);
            i += 2;
          }
          tag += hex.substr(i, 2);
          i += 2;
        }

        // Length
        let lenByte = parseInt(hex.substr(i, 2), 16);
        i += 2;
        let length = lenByte;
        if ((lenByte & 0x80) !== 0) {
          const lenLen = lenByte & 0x7F;
          length = parseInt(hex.substr(i, lenLen * 2), 16);
          i += lenLen * 2;
        }

        const valueHex = hex.substr(i, length * 2);
        i += length * 2;

        if (tag === '61') {
          result[tag] = parseTLV(valueHex);
        } else if (tag === '5A') {
          // Decode PAN from compressed BCD
          const digits = valueHex.match(/.{2}/g)
            .map(byte => {
              const high = (parseInt(byte, 16) >> 4) & 0xF;
              const low = parseInt(byte, 16) & 0xF;
              return `${high}${low}`;
            }).join('').replace(/F+$/, '').slice(0, 19);
          result[tag] = digits;
        } else if (keepAsHexTags.includes(tag)) {
          result[tag] = valueHex.toUpperCase();
        } else {
          const ascii = valueHex.match(/.{2}/g)
            .map(h => String.fromCharCode(parseInt(h, 16)))
            .join('').trim();
          result[tag] = ascii;
        }
      }

      return result;
    }

    function format(obj, indent = 0) {
      const pad = '  '.repeat(indent);
      const entries = Object.entries(obj).map(([k, v]) => {
        if (typeof v === 'object') {
          return `${pad}"${k}": {\n${format(v, indent + 1)}\n${pad}}`;
        } else {
          return `${pad}"${k}": "${v}"`;
        }
      });
      return entries.join(',\n');
    }
  </script>
</body>
</html>
